{% extends "tool/base.html" %}
{% block content %}

<h2>Viva Summary</h2>

<div class="card">
    <p><strong>Started:</strong> {{ session.started_at }}</p>
    <p><strong>Ended:</strong> {{ session.ended_at }}</p>

    <p><strong>Duration:</strong>
        {% if formatted_duration %}
            {{ formatted_duration }}
        {% else %}
            Still in progress
        {% endif %}
    </p>

    {% if flags %}
    <p><strong>Integrity Flags:</strong></p>
    <ul>
        {% for f in flags %}
            <li style="color:#b30000; font-weight:600;">ðŸš© {{ f }}</li>
        {% endfor %}
    </ul>
    {% else %}
        <p><strong>Integrity Flags:</strong> None detected.</p>
    {% endif %}


    <a href="{% url 'viva_logs' session.id %}" class="button" style="margin-right: 10px;">
        View Behaviour Logs
    </a>
</div>

{% if feedback %}
<div id="feedbackContainer" class="card" style="margin-top:20px;">
    <h3>Qualitative Feedback</h3>

    <h4>Strengths</h4>
    <p>{{ feedback.strengths }}</p>

    <h4>Areas for Improvement</h4>
    <p>{{ feedback.improvements }}</p>

    <h4>Misconceptions Identified</h4>
    <p>{{ feedback.misconceptions }}</p>

    <h4>Overall Academic Impression</h4>
    <p>{{ feedback.impression }}</p>
</div>
{% else %}
<div id="feedbackContainer" class="card" style="margin-top:20px; text-align:center;">
    <h3>Qualitative Feedback</h3>

    <div id="feedbackSpinner" style="padding:20px;">
        <div class="loader"></div>
        <p style="margin-top:10px;">Generating feedbackâ€¦</p>
    </div>
</div>
{% endif %}

<div class="card">
    <h3>Transcript</h3>

    {% for msg in messages %}
        <div style="
            margin-bottom: 12px;
            padding: 10px 15px;
            border-radius: 10px;
            background: {% if msg.sender == 'student' %}#e0ffe0{% else %}#f1f1f1{% endif %};
            max-width: 90%;
        ">
            <strong>{{ msg.sender|title }}:</strong><br>
            <div style="white-space: pre-wrap; margin-top: 4px;">
                {{ msg.text }}
            </div>
        </div>
    {% endfor %}
</div>

<a href="{% url 'assignment_view' %}" class="button">Return to Assignment</a>

{% endblock %}

<script>
document.addEventListener("DOMContentLoaded", function () {
    const feedbackContainer = document.getElementById("feedbackContainer");
    const spinner = document.getElementById("feedbackSpinner");

    // If feedback already present â†’ do nothing
    if (!spinner) return;

    function pollFeedback() {
        fetch("?poll=1")
            .then(r => r.json())
            .then(data => {
                if (!data.ready) {
                    setTimeout(pollFeedback, 2000);
                    return;
                }

                // Replace spinner with actual feedback
                spinner.style.display = "none";

                feedbackContainer.innerHTML = `
                    <h3>Qualitative Feedback</h3>

                    <h4>Strengths</h4>
                    <p>${data.strengths}</p>

                    <h4>Areas for Improvement</h4>
                    <p>${data.improvements}</p>

                    <h4>Misconceptions Identified</h4>
                    <p>${data.misconceptions}</p>

                    <h4>Overall Academic Impression</h4>
                    <p>${data.impression}</p>
                `;
            });
    }

    pollFeedback();
});
</script>

