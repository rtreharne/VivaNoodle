{% extends "tool/base.html" %}
{% load tool_extras %}

{% block content %}

<h2>{{ assignment.title }}</h2>

<div class="button-group mb-20">
    <a href="{% url 'assignment_edit' %}" class="button primary">Edit Assignment</a>
</div>

<h3>Submissions</h3>

<!-- Filter Button -->
<div class="vn-filter-controls">
    <button id="toggleFlaggedBtn"
            class="button small vn-flag-filter-btn"
            data-mode="all">
        Show Flagged Only
    </button>
</div>

<div class="card full-width">

    {% if roster %}
    <table class="vn-table full">

        <thead>
            <tr>
                <th>Student</th>
                <th>Status</th>
                <th>Flags</th>
                <th>View</th>
            </tr>
        </thead>

        <tbody>
        {% for member in roster %}
            {% if "learner" in member.roles|join:","|lower %}

                {% with uid=member.user_id %}
                {% with sub=submission_map|dict_get:uid %}
                {% with flags=flag_map|dict_get:uid %}

                <tr class="submission-row"
                    data-flagged="{% if flags %}true{% else %}false{% endif %}">

                    <!-- Student name -->
                    <td>{{ member.sortable_name }}</td>

                    <!-- Submission status -->
                    {% if sub %}
                        <td class="submitted">
                            Submitted ({{ sub.created_at|date:"Y-m-d H:i" }})
                        </td>
                    {% else %}
                        <td class="not-submitted">
                            Not Submitted
                        </td>
                    {% endif %}

                    <!-- Flags -->
                    <td>
                        {% if sub and sub.vivasession %}
                            {% if flags %}
                                <span class="flag-icon" data-tip="{{ flags|join:'\n' }}">
                                    ðŸš©
                                </span>
                            {% else %}
                                <span class="no-flag">â€”</span>
                            {% endif %}
                        {% else %}
                            <span class="no-flag">â€”</span>
                        {% endif %}
                    </td>

                    <!-- View buttons -->
                    <td>
                        {% if sub %}
                            <a href="{% url 'submission_status' sub.id %}" class="button small">
                                View
                            </a>

                            {% if sub.vivasession %}
                                <a href="{% url 'viva_summary' sub.vivasession.id %}"
                                   class="button small ml-6">
                                    Viva
                                </a>
                            {% endif %}
                        {% else %}
                            â€”
                        {% endif %}
                    </td>

                </tr>

                {% endwith %}
                {% endwith %}
                {% endwith %}

            {% endif %}
        {% endfor %}
        </tbody>

    </table>

    {% else %}
        <p>No roster data available.</p>
    {% endif %}

</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    const btn = document.getElementById("toggleFlaggedBtn");
    if (!btn) return;

    btn.addEventListener("click", function () {
        const showOnly = (this.dataset.mode !== "flagged");
        const rows = document.querySelectorAll(".submission-row");

        rows.forEach(row => {
            const flagged = row.dataset.flagged === "true";
            row.style.display = (showOnly && !flagged) ? "none" : "";
        });

        if (showOnly) {
            this.textContent = "Show All Students";
            this.dataset.mode = "flagged";
            this.classList.add("vn-active");
        } else {
            this.textContent = "Show Flagged Only";
            this.dataset.mode = "all";
            this.classList.remove("vn-active");
        }
    });

});
</script>
{% endblock %}
