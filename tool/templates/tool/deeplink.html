{% load static %}
{% now "U" as cachebust %}
{% now "Y" as year %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MachinaViva | Create Assignment</title>
    <link rel="stylesheet" href="{% static 'tool/home.css' %}?v={{ cachebust }}">
</head>
<body>
<div class="page">

    <header class="nav">
        <div class="brand">
            <span class="brand-mark">MV</span>
            <span>MachinaViva</span>
        </div>
        <div class="nav-title">Create assignment</div>
        <div class="nav-actions">
            <button class="view-btn ghost" type="button" data-theme-toggle aria-label="Toggle theme">Light</button>
        </div>
    </header>

    <section class="section dash-compact">
        <div class="section-head compact">
            <div>
                <p class="eyebrow">Deep linking</p>
                <h2>Configure your MachinaViva assignment</h2>
                <p class="meta">These settings can be adjusted later in the Viva settings page.</p>
            </div>
        </div>

        <form method="POST"
              action="{% if edit_mode %}{% url 'deeplink_edit_submit' %}{% else %}{% url 'deeplink_submit' %}{% endif %}"
              class="settings-grid max-two"
              novalidate>
            {% csrf_token %}
            <input type="hidden" name="return_url" value="{{ deep_link_return }}">

            <div class="settings-form-card">
                <div class="settings-card-head">
                    <h3 class="settings-title">Overview</h3>
                </div>
                <div class="settings-row">
                    <label for="title">Assignment title</label>
                    <input id="title" name="title"
                           value="{% if edit_mode %}{{ assignment.title }}{% else %}Viva Assignment{% endif %}"
                           required>
                </div>
                <div class="settings-row">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3" placeholder="Short summary for staff and students.">{% if edit_mode %}{{ assignment.description }}{% endif %}</textarea>
                </div>
                <div class="settings-row split">
                    <div>
                        <label for="viva_duration_minutes">Duration</label>
                        <input type="number" id="viva_duration_minutes" name="viva_duration_minutes" min="1" step="1" value="{% if edit_mode %}{{ duration_minutes|default:default_duration_minutes }}{% else %}{{ default_duration_minutes }}{% endif %}">
                    </div>
                    <div>
                        <label for="max_attempts">Attempts</label>
                        <input type="number" id="max_attempts" name="max_attempts" min="1" max="5" step="1" value="{% if edit_mode %}{{ assignment.max_attempts|default_if_none:default_max_attempts }}{% else %}{{ default_max_attempts }}{% endif %}" {% if edit_mode %}{% if not assignment.max_attempts or assignment.max_attempts <= 0 %}disabled{% endif %}{% endif %}>
                        <div class="unlimited-toggle">
                            <span class="meta">Unlimited</span>
                            <label class="switch">
                                <input type="checkbox" id="unlimited_attempts" name="unlimited_attempts" {% if edit_mode %}{% if not assignment.max_attempts or assignment.max_attempts <= 0 %}checked{% endif %}{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="viva_tone">Tone</label>
                        <select id="viva_tone" name="viva_tone">
                            {% for tone in tones %}
                                <option value="{{ tone }}" {% if edit_mode %}{% if assignment.viva_tone == tone %}selected{% endif %}{% else %}{% if tone == default_viva_tone %}selected{% endif %}{% endif %}>{{ tone }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="settings-row">
                    <label>Feedback visibility</label>
                    <div class="tracking-table">
                        <div class="tracking-item">
                            <div>
                                <div class="tracking-label">Show AI feedback</div>
                                <div class="meta">AI feedback is visible to students.</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" name="ai_feedback_visible" {% if edit_mode %}{% if assignment.ai_feedback_visible %}checked{% endif %}{% else %}{% if default_ai_feedback_visible %}checked{% endif %}{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="tracking-item">
                            <div>
                                <div class="tracking-label">Show teacher feedback</div>
                                <div class="meta">Teacher feedback is visible to students.</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" name="teacher_feedback_visible" {% if edit_mode %}{% if assignment.teacher_feedback_visible %}checked{% endif %}{% else %}{% if default_teacher_feedback_visible %}checked{% endif %}{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="settings-row">
                    <label>Student report</label>
                    <div class="tracking-table">
                        <div class="tracking-item">
                            <div>
                                <div class="tracking-label">Download feedback/transcript</div>
                                <div class="meta">Allow students to export their session.</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" name="allow_student_report" {% if edit_mode %}{% if assignment.allow_student_report %}checked{% endif %}{% else %}{% if default_allow_student_report %}checked{% endif %}{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="tracking-item">
                            <div>
                                <div class="tracking-label">Allow early submission</div>
                                <div class="meta">Students can finish before the timer ends.</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" name="allow_early_submission" {% if edit_mode %}{% if assignment.allow_early_submission %}checked{% endif %}{% else %}{% if default_allow_early_submission %}checked{% endif %}{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="tracking-item">
                            <div>
                                <div class="tracking-label">Enable model answers</div>
                                <div class="meta">Show exemplar answers after completion.</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" name="enable_model_answers" {% if edit_mode %}{% if assignment.enable_model_answers %}checked{% endif %}{% else %}{% if default_enable_model_answers %}checked{% endif %}{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="tracking-item">
                            <div>
                                <div class="tracking-label">Allow students to toggle instructor files</div>
                                <div class="meta">Students must include at least one file.</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" name="allow_student_resource_toggle" {% if edit_mode %}{% if assignment.allow_student_resource_toggle %}checked{% endif %}{% else %}{% if default_allow_student_resource_toggle %}checked{% endif %}{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="settings-row">
                    <label>Tracking</label>
                    <div class="tracking-table">
                        <div class="tracking-item">
                            <div>
                                <div class="tracking-label">Event tracking</div>
                                <div class="meta">Paste, blur/focus, window changes.</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" name="event_tracking" {% if edit_mode %}{% if assignment.event_tracking %}checked{% endif %}{% else %}{% if default_event_tracking %}checked{% endif %}{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="tracking-item">
                            <div>
                                <div class="tracking-label">Keystroke tracking</div>
                                <div class="meta">Pacing signals.</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" name="keystroke_tracking" {% if edit_mode %}{% if assignment.keystroke_tracking %}checked{% endif %}{% else %}{% if default_keystroke_tracking %}checked{% endif %}{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="tracking-item">
                            <div>
                                <div class="tracking-label">Arrhythmic typing</div>
                                <div class="meta">Flag irregular bursts.</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" name="arrhythmic_typing" {% if edit_mode %}{% if assignment.arrhythmic_typing %}checked{% endif %}{% else %}{% if default_arrhythmic_typing %}checked{% endif %}{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-form-card">
                <div class="settings-card-head">
                    <h3 class="settings-title">Tone & guidance</h3>
                </div>
                <div class="settings-row">
                    <label for="viva_instructions">Core viva instructions</label>
                    <textarea id="viva_instructions" name="viva_instructions" rows="4" placeholder="How should the AI conduct the viva? Tone, strictness, what to probe, what to avoid.">{% if edit_mode %}{{ assignment.viva_instructions }}{% endif %}</textarea>
                </div>
                <div class="settings-row">
                    <label for="additional_prompts">Additional prompts</label>
                    <textarea id="additional_prompts" name="additional_prompts" rows="3" placeholder="Any bespoke prompts or discipline-specific instructions.">{% if edit_mode %}{{ assignment.additional_prompts }}{% endif %}</textarea>
                </div>
                <div class="settings-row">
                    <label for="instructor_notes">Instructor notes (private)</label>
                    <textarea id="instructor_notes" name="instructor_notes" rows="3" placeholder="Private notes about this viva.">{% if edit_mode %}{{ assignment.instructor_notes }}{% endif %}</textarea>
                </div>
            </div>

            <div class="settings-actions">
                <button class="control-btn primary" type="submit">
                    {% if edit_mode %}Save changes{% else %}Create assignment{% endif %}
                </button>
            </div>
        </form>
    </section>

    <footer class="footer">
        <p>© 2025 MachinaViva · Authentic viva assessments for the AI era.</p>
    </footer>
</div>

<script>
    (() => {
        const unlimited = document.getElementById("unlimited_attempts");
        const attempts = document.getElementById("max_attempts");
        if (!unlimited || !attempts) return;
        const toggle = () => {
            attempts.disabled = unlimited.checked;
            if (unlimited.checked) {
                attempts.value = 0;
            } else if (!attempts.value || Number(attempts.value) < 1) {
                attempts.value = 1;
            }
        };
        unlimited.addEventListener("change", toggle);
        toggle();
    })();
</script>
<script>
    (() => {
        const themeToggle = document.querySelector("[data-theme-toggle]");
        if (!themeToggle) return;
        const root = document.documentElement;
        const applyTheme = (mode) => {
            if (mode === "light") {
                root.setAttribute("data-theme", "light");
                themeToggle.textContent = "Dark";
            } else {
                root.setAttribute("data-theme", "dark");
                themeToggle.textContent = "Light";
            }
            localStorage.setItem("mv-theme", mode);
        };
        const saved = localStorage.getItem("mv-theme");
        applyTheme(saved === "light" ? "light" : "dark");
        themeToggle.addEventListener("click", () => {
            const current = root.getAttribute("data-theme") === "light" ? "light" : "dark";
            applyTheme(current === "light" ? "dark" : "light");
        });
    })();
</script>
</body>
</html>
