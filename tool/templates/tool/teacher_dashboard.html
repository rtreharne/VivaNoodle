{% load static %}
{% load tz %}
{% now "U" as cachebust %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MachinaViva | Teacher Dashboard</title>
    <link rel="stylesheet" href="{% static 'tool/home.css' %}?v={{ cachebust }}">
    <script defer src="{% static 'tool/teacher_dashboard.js' %}?v={{ cachebust }}"></script>
    <script defer src="{% static 'tool/nav.js' %}?v={{ cachebust }}"></script>
</head>
<body>
<div class="page page-with-footer">

    <header class="nav nav-spread nav-with-menu">
        {% if from_standalone %}
            <a class="brand" href="{% url 'landing_home' %}" aria-label="MachinaViva home">
                <span class="brand-mark">MV</span>
                <span>MachinaViva</span>
            </a>
        {% else %}
            <div class="brand">
                <span class="brand-mark">MV</span>
                <span>MachinaViva</span>
            </div>
        {% endif %}
        <button class="nav-toggle" data-nav-toggle aria-label="Toggle navigation">Menu</button>
        <div class="nav-actions view-toggle" data-nav-links>
            {% if from_standalone %}
                <a class="view-btn" href="{% url 'standalone_app_home' %}">My assignments</a>
                <button class="view-btn ghost" type="button" data-theme-toggle aria-label="Toggle theme">☀</button>
                <span class="user-chip">
                    {{ request.user.email|default:request.user.username }}
                    <span class="chip-divider">·</span>
                    <a class="link" href="{% url 'standalone_logout' %}">Logout</a>
                </span>
            {% else %}
                <button class="view-btn active" data-view-switch="dashboard">Dashboard</button>
                <button class="view-btn mobile-icon-btn" data-view-switch="settings" aria-label="Viva settings" title="Viva settings">
                    <span class="icon" aria-hidden="true">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" focusable="false">
                            <line x1="4" y1="21" x2="4" y2="14"></line>
                            <line x1="4" y1="10" x2="4" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12" y2="3"></line>
                            <line x1="20" y1="21" x2="20" y2="16"></line>
                            <line x1="20" y1="12" x2="20" y2="3"></line>
                            <line x1="1" y1="14" x2="7" y2="14"></line>
                            <line x1="9" y1="8" x2="15" y2="8"></line>
                            <line x1="17" y1="16" x2="23" y2="16"></line>
                        </svg>
                    </span>
                    <span class="label">Viva settings</span>
                </button>
                <button class="view-btn ghost" type="button" data-theme-toggle aria-label="Toggle theme">☀</button>
            {% endif %}
        </div>
    </header>

    <section id="dashboard" class="section dash-compact">
        <div class="standalone-header">
            <div>
                <h2>{{ assignment.title|default:"Viva assignment" }}</h2>
                <p class="standalone-muted monospace">{{ assignment.slug }}</p>
            </div>
        </div>
        <div class="table-controls table-controls-split">
            <div class="table-controls-left">
                {% if from_standalone %}
                    <button class="view-btn mobile-icon-btn active" data-view-switch="dashboard" data-transcript-back aria-label="Roster" title="Roster">
                        <span class="icon" aria-hidden="true">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" focusable="false">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </span>
                        <span class="label">Roster</span>
                    </button>
                    <button class="view-btn mobile-icon-btn" data-view-switch="settings" aria-label="Viva settings" title="Viva settings">
                        <span class="icon" aria-hidden="true">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" focusable="false">
                                <line x1="4" y1="21" x2="4" y2="14"></line>
                                <line x1="4" y1="10" x2="4" y2="3"></line>
                                <line x1="12" y1="21" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12" y2="3"></line>
                                <line x1="20" y1="21" x2="20" y2="16"></line>
                                <line x1="20" y1="12" x2="20" y2="3"></line>
                                <line x1="1" y1="14" x2="7" y2="14"></line>
                                <line x1="9" y1="8" x2="15" y2="8"></line>
                                <line x1="17" y1="16" x2="23" y2="16"></line>
                            </svg>
                        </span>
                        <span class="label">Viva settings</span>
                    </button>
                    <a class="view-btn mobile-icon-btn" href="#" data-access-modal-open aria-label="Manage Access" title="Manage Access">
                        <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="18" cy="5" r="3"></circle>
                            <circle cx="6" cy="12" r="3"></circle>
                            <circle cx="18" cy="19" r="3"></circle>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                        </svg>
                    </a>
                    {% if can_switch_to_student %}
                        <a class="view-btn mobile-icon-btn" href="{% url 'standalone_student_entry' assignment.slug %}" aria-label="Student view" title="Student view">
                            <span class="icon" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" focusable="false">
                                    <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6Z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </span>
                            <span class="label">Student view</span>
                        </a>
                    {% else %}
                        <a class="view-btn mobile-icon-btn" href="{% url 'standalone_view_as_student' assignment.slug %}" aria-label="View as student" title="View as student">
                            <span class="icon" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" focusable="false">
                                    <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6Z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </span>
                            <span class="label">View as student</span>
                        </a>
                    {% endif %}
                    <button class="view-btn mobile-icon-btn" type="button" data-export-csv aria-label="Export filtered roster CSV" title="Export CSV">
                        <span class="icon" aria-hidden="true">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" focusable="false">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </span>
                        <span class="label">Export CSV</span>
                    </button>
                {% endif %}
            </div>
            <div class="table-controls-right" data-dashboard-controls>
                <input type="search" class="filter-input" placeholder="Filter students by name..." aria-label="Filter students" data-student-filter>
            </div>
        </div>
        <div class="dash-view active" data-view-pane="dashboard">
            <div class="carousel">
                <div class="carousel-pane active" data-dash-pane="table">
                    <div class="table-card">
                        <div class="table-head">
                            <div>Student</div>
                            <div>
                                <button class="table-filter" type="button" data-filter="viva" aria-pressed="false">
                                    Viva
                                    <span class="filter-indicator is-hidden" data-filter-indicator="viva"></span>
                                </button>
                            </div>
                            <div>
                                <button class="table-filter" type="button" data-filter="flags" aria-pressed="false">
                                    Integrity flags
                                    <span class="filter-indicator is-hidden" data-filter-indicator="flags"></span>
                                </button>
                            </div>
                        </div>

                        {% if students %}
                            {% for student in students %}
                                <div class="table-row"
                                     data-student-row
                                     data-student-id="{{ student.user_id }}"
                                     data-student-search="{{ student.name|lower }} {{ student.email|default:''|lower }}"
                                     data-viva-status="{{ student.status|default:'pending' }}"
                                     data-has-flags="{% if student.flags %}true{% else %}false{% endif %}">
                                    <div class="viva-cell student-cell" data-label="Student">
                                        {% if student.is_invite %}
                                            <span class="monospace">{{ student.name }}</span>
                                            {% if student.invite_status != "Accepted" %}
                                                <span class="pill {% if student.invite_status == 'Expired' %}no{% else %}neutral{% endif %}" data-invite-status-pill>{{ student.invite_status|default:"Invited" }}</span>
                                            {% endif %}
                                        {% else %}
                                            {{ student.name }}
                                        {% endif %}
                                    </div>
                                    <div class="viva-cell" data-label="Viva">
                                        {% if student.status == "completed" %}
                                            <span class="viva-status yes" aria-label="Completed"></span>
                                            <a href="#" class="link view-transcript" data-view-transcript="{{ student.user_id }}">View</a>
                                        {% elif student.status == "in_progress" %}
                                            <span class="viva-status warn" aria-label="In progress"></span>
                                            <a href="#" class="link view-transcript" data-view-transcript="{{ student.user_id }}">Open</a>
                                            <span class="meta">⏱ <span data-remaining="{{ student.remaining_seconds|default:0 }}"></span></span>
                                        {% elif student.status == "submitted" %}
                                            <span class="viva-status no" aria-label="Submitted"></span>
                                            <span class="link disabled">Submitted</span>
                                        {% else %}
                                            {% if student.is_invite and student.invite_id and student.invite_status != "Accepted" %}
                                                <a class="pill neutral" href="{% url 'standalone_invite_resend' student.invite_id %}" data-invite-resend>Re-send</a>
                                            {% else %}
                                                <span class="viva-status no" aria-label="Pending"></span>
                                                <span class="link disabled">Viva pending</span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <div class="flag {% if student.flags %}warn{% else %}none{% endif %}" data-label="Integrity flags">
                                        {% if student.flags %}
                                            <details class="flag-details">
                                                <summary>{{ student.flags|length }} flag{% if student.flags|length != 1 %}s{% endif %}</summary>
                                                <ul>
                                                    {% for item in student.flags %}
                                                        <li>{{ item }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </details>
                                        {% elif student.status == "completed" or student.status == "in_progress" %}
                                            No flags
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="table-row">
                                <div>No roster available</div>
                                <div class="viva-cell"><span class="viva-status no"></span><span class="link disabled">—</span></div>
                                <div class="flag none">—</div>
                            </div>
                        {% endif %}
                    </div>
                    <p class="table-note" data-table-note>Live roster and transcript view for this assignment. Click “View” to open a transcript.</p>
                </div>

                <div class="carousel-pane" data-dash-pane="transcript">
                    <div class="transcript-layout">
                        <div class="transcript-card">
                            <div class="transcript-head">
                                <div>
                                    <div class="name-row">
                                        <select class="transcript-select" data-transcript-select>
                                            <option value="" selected disabled>Select a student</option>
                                        </select>
                                    </div>
                                    <div class="name-row">
                                        <select class="transcript-select" data-attempt-select>
                                            <option value="" selected disabled>Select attempt</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="transcript-head-actions"></div>
                            </div>
                            <div class="transcript-meta">
                                <span class="transcript-duration" data-transcript-duration>Duration: —</span>
                            </div>
                            <div class="transcript-chat" data-transcript-chat>
                                <div class="bubble system">Select a student with a completed viva to view the transcript.</div>
                            </div>
                            <div class="transcript-files" data-transcript-files></div>
                        </div>

                        <aside class="transcript-side">
                            <div class="side-card">
                                <p class="tiny">Integrity events</p>
                                <ul class="event-list transcript-events" data-transcript-events>
                                    <li class="muted">No transcript selected.</li>
                                </ul>
                            </div>
                            <div class="side-card">
                                <p class="tiny">AI feedback</p>
                                <div class="feedback-block" data-ai-feedback>AI feedback will appear once the viva ends.</div>
                            </div>
                            <div class="side-card">
                                <p class="tiny">Teacher feedback</p>
                                <form class="feedback-form" data-teacher-feedback-form>
                                    <div class="settings-row">
                                        <textarea rows="4" placeholder="Add teacher feedback for this attempt." data-teacher-feedback-input></textarea>
                                    </div>
                                    <p class="meta is-hidden" data-teacher-feedback-author></p>
                                    <div class="settings-actions">
                                        <button class="control-btn" type="submit">Save feedback</button>
                                        <span class="meta status-line" data-teacher-feedback-status></span>
                                    </div>
                                </form>
                            </div>
                        </aside>
                    </div>
                </div>

            </div>
        </div>

        <div class="dash-view" data-view-pane="settings">
            <form id="settings-form" class="settings-grid max-two" method="POST" action="{% url 'assignment_edit_save' %}" data-settings-form novalidate>
                {% csrf_token %}
                <div class="settings-form-card">
                    <div class="settings-card-head">
                        <h3 class="settings-title">Overview</h3>
                    </div>
                    <div class="settings-row split">
                        <div>
                            <label>Viva title</label>
                            <div class="meta">{{ assignment.title }}</div>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label for="description">Description</label>
                        <textarea id="description" name="description" rows="2" placeholder="Short summary for staff and students.">{{ assignment.description }}</textarea>
                    </div>
                    <div class="settings-row">
                        <label for="deadline_at">Deadline</label>
                        <input
                            type="datetime-local"
                            id="deadline_at"
                            name="deadline_at"
                            value="{% if assignment.deadline_at %}{{ assignment.deadline_at|localtime|date:"Y-m-d\\TH:i" }}{% endif %}"
                        >
                        <div class="meta">Uses the instructor timezone.</div>
                    </div>
                    <div class="settings-row split">
                        <div>
                            <label for="viva_duration_minutes">Duration</label>
                            <input type="number" id="viva_duration_minutes" name="viva_duration_minutes" min="1" step="1" value="{{ duration_minutes|default:10 }}">
                        </div>
                        <div>
                            <label for="max_attempts">Attempts</label>
                            <input type="number" id="max_attempts" name="max_attempts" min="1" max="5" step="1" value="{{ assignment.max_attempts|default:1 }}" {% if not assignment.max_attempts or assignment.max_attempts <= 0 %}disabled{% endif %}>
                            <div class="unlimited-toggle">
                                <span class="meta">Unlimited</span>
                                <label class="switch">
                                    <input type="checkbox" id="unlimited_attempts" name="unlimited_attempts" {% if not assignment.max_attempts or assignment.max_attempts <= 0 %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label for="viva_tone">Tone</label>
                            <select id="viva_tone" name="viva_tone">
                                {% for tone in tones %}
                                    <option value="{{ tone }}" {% if assignment.viva_tone == tone %}selected{% endif %}>{{ tone }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>Feedback visibility</label>
                        <div class="tracking-table">
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Show AI feedback</div>
                                    <div class="meta">AI feedback is visible to students.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="ai_feedback_visible" {% if assignment.ai_feedback_visible %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Show teacher feedback</div>
                                    <div class="meta">Teacher feedback is visible to students.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="teacher_feedback_visible" {% if assignment.teacher_feedback_visible %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>Student report</label>
                        <div class="tracking-table">
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Download feedback/transcript</div>
                                    <div class="meta">Allow students to export their session.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="allow_student_report" {% if assignment.allow_student_report %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Allow early submission</div>
                                    <div class="meta">Students can finish before the timer ends.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="allow_early_submission" {% if assignment.allow_early_submission %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Enable model answers</div>
                                    <div class="meta">Show exemplar answers after completion.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="enable_model_answers" {% if assignment.enable_model_answers %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Allow students to toggle instructor files</div>
                                    <div class="meta">Students must include at least one file.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="allow_student_resource_toggle" {% if assignment.allow_student_resource_toggle %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>Tracking</label>
                        <div class="tracking-table">
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Event tracking</div>
                                    <div class="meta">Paste, blur/focus, window changes.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="event_tracking" {% if assignment.event_tracking %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Keystroke tracking</div>
                                    <div class="meta">Pacing signals.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="keystroke_tracking" {% if assignment.keystroke_tracking %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Arrhythmic typing</div>
                                    <div class="meta">Flag irregular bursts.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="arrhythmic_typing" {% if assignment.arrhythmic_typing %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-form-card">
                    <div class="settings-card-head">
                        <h3 class="settings-title">Tone & guidance</h3>
                    </div>
                    <div class="settings-row">
                        <label for="viva_instructions">Core viva instructions</label>
                        <textarea id="viva_instructions" name="viva_instructions" rows="4" placeholder="How should the AI conduct the viva? Tone, strictness, what to probe, what to avoid.">{{ assignment.viva_instructions }}</textarea>
                    </div>

                    <div class="settings-row">
                        <label for="additional_prompts">Additional prompts</label>
                        <textarea id="additional_prompts" name="additional_prompts" rows="3" placeholder="Any bespoke prompts or discipline-specific instructions.">{{ assignment.additional_prompts }}</textarea>
                    </div>

                    <div class="settings-row">
                        <label for="instructor_notes">Instructor notes (private)</label>
                        <textarea id="instructor_notes" name="instructor_notes" rows="3" placeholder="Private notes about this viva.">{{ assignment.instructor_notes }}</textarea>
                    </div>
                </div>

                <div class="settings-form-card" data-resource-upload>
                    <div class="settings-card-head">
                        <h3 class="settings-title">Viva files</h3>
                    </div>
                    <div class="settings-row">
                        <label>Files</label>
                        <div class="submission-table-wrap" data-resource-list>
                            <div class="submission-table-header">
                                <span>File</span>
                                <span>Include</span>
                                <span>Actions</span>
                            </div>
                            <div class="submission-table-body">
                                {% for resource in assignment_resources %}
                                    <div class="submission-row {% cycle 'row-alt' '' %}"
                                         data-resource-id="{{ resource.id }}"
                                         data-included="{{ resource.included|yesno:'1,0' }}"
                                         data-file-name="{{ resource.file_name|cut:'assignment_resources/'|default:'uploaded file' }}"
                                         data-comment="{{ resource.comment|default_if_none:''|escapejs }}"
                                         data-file-size="{{ resource.file_size|default:0 }}">
                                        <div class="submission-cell file-name">
                                            {{ resource.file_name|cut:"assignment_resources/"|default:"uploaded file"|truncatechars:40 }}
                                            <div class="meta">
                                                <a class="link file-preview"
                                                   href="#"
                                                   data-preview-text="{{ resource.comment|default_if_none:''|escapejs }}">
                                                    Preview text
                                                </a>
                                            </div>
                                        </div>
                                        <div class="submission-cell">
                                            <label class="slider-toggle" aria-label="Include in viva">
                                                <input type="checkbox" data-resource-include {% if resource.included %}checked{% endif %}>
                                                <span class="slider-track">
                                                    <span class="slider-thumb"></span>
                                                </span>
                                            </label>
                                        </div>
                                        <div class="submission-cell submission-actions">
                                            <button class="icon-btn danger" type="button" data-delete-resource="{{ resource.id }}">Delete</button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="meta {% if assignment_resources %}is-hidden{% endif %}" data-resource-empty>
                            No viva files yet. Upload files below.
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>Upload files</label>
                        <div class="submission-form upload-inline"
                             data-resource-upload-form
                             data-upload-url="{% url 'upload_assignment_resource' %}"
                             data-existing-count="{{ assignment_resources|length|default:0 }}"
                             data-existing-size="{{ resources_total_size|default:0 }}">
                            <input type="file" name="file" accept=".pdf,.docx,.txt" multiple data-resource-upload-input>
                            <button type="button" class="control-btn" data-resource-upload-btn>Upload</button>
                        </div>
                        <div class="meta upload-hint is-hidden" data-resource-upload-hint></div>
                    </div>
                </div>

                <div class="settings-actions">
                    <span class="meta" data-save-status></span>
                </div>
            </form>

        </div>
        <button class="back-to-top" type="button" data-back-to-top aria-label="Back to top">↑ Top</button>
    </section>

    <footer class="footer">
        <p>© 2025 MachinaViva</p>
    </footer>
</div>

{{ dashboard_data|json_script:"dashboard-data" }}
<div class="save-toast" data-save-toast>Settings updated</div>
<div class="preview-modal" data-preview-modal>
    <div class="preview-dialog">
        <div class="preview-head">
            <span>Submission preview</span>
            <button class="icon-btn" type="button" data-preview-close aria-label="Close preview">×</button>
        </div>
        <div class="preview-body">
            <pre data-preview-content>(No preview available)</pre>
        </div>
    </div>
</div>
{% if from_standalone %}
<div class="invite-modal" data-access-modal>
    <div class="invite-dialog">
        <div class="invite-head">
            <h3>Manage access</h3>
            <button class="icon-btn" type="button" data-access-modal-close aria-label="Close invite modal">×</button>
        </div>
        <div class="settings-grid single-column">
            <div class="settings-form-card">
                <div class="settings-card-head">
                    <h3 class="settings-title">Invite students via email</h3>
                </div>
                <form method="post" action="{% url 'standalone_invite_create' assignment.slug %}" class="settings-grid single-column" data-invite-form>
                    {% csrf_token %}
                    <div class="settings-row">
                        <label for="invite-email">Student email</label>
                        <input id="invite-email" name="email" type="email" required placeholder="student@university.edu">
                    </div>
                    <div class="settings-row">
                        <label for="invite-role">Role</label>
                        <select id="invite-role" name="role">
                            <option value="student" selected>Student</option>
                            <option value="instructor">Instructor</option>
                        </select>
                    </div>
                    <div class="settings-actions">
                        <button type="submit" class="view-btn">Send invite</button>
                        <button type="button" class="view-btn ghost" data-access-modal-close>Cancel</button>
                    </div>
                    <p class="meta">We'll email a secure link. Pending invites stay in the roster until they are accepted.</p>
                    <p class="meta status-line" data-invite-status></p>
                </form>
            </div>

            <div class="settings-form-card">
                <div class="settings-card-head">
                    <h3 class="settings-title">Self-enrol link</h3>
                </div>
                <form method="post" action="{% url 'standalone_self_enroll_manage' assignment.slug %}" class="settings-grid single-column" data-self-enroll-form>
                    {% csrf_token %}
                    <div class="settings-row">
                        <label for="self-enroll-link">Share link</label>
                        <input id="self-enroll-link" type="text" value="{{ self_enroll_link }}" readonly data-self-enroll-link>
                        <div class="meta">Share this link so students can self-enrol.</div>
                    </div>
                    <div class="settings-row">
                        <label for="self-enroll-domain">Allowed email domain (optional)</label>
                        <input id="self-enroll-domain" name="self_enroll_domain" type="text" value="{{ assignment.self_enroll_domain }}" placeholder="example.edu">
                        <div class="meta">Leave blank to allow any domain.</div>
                    </div>
                    <div class="settings-actions">
                        <button type="button" class="view-btn ghost" data-copy-target="self-enroll-link">Copy link</button>
                        <button type="submit" class="view-btn">Save domain</button>
                        <button type="submit" class="view-btn ghost" name="action" value="regenerate">Regenerate link</button>
                    </div>
                    <p class="meta status-line" data-self-enroll-status></p>
                </form>
            </div>

            <div class="settings-form-card">
                <div class="settings-card-head">
                    <h3 class="settings-title">Embed code</h3>
                </div>
                <div class="settings-row">
                    <label for="self-enroll-iframe">Iframe snippet</label>
                    <textarea id="self-enroll-iframe" rows="4" readonly>{{ self_enroll_iframe|safe }}</textarea>
                    <div class="meta">Paste this into your course site to embed self-enrol.</div>
                </div>
                <div class="settings-actions">
                    <button type="button" class="view-btn ghost" data-copy-target="self-enroll-iframe">Copy iframe</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
<script>
    (() => {
        const unlimited = document.getElementById("unlimited_attempts");
        const attempts = document.getElementById("max_attempts");
        if (!unlimited || !attempts) return;
        const toggle = () => {
            attempts.disabled = unlimited.checked;
            if (unlimited.checked) {
                attempts.value = 0;
            } else if (!attempts.value || Number(attempts.value) < 1) {
                attempts.value = 1;
            }
        };
        unlimited.addEventListener("change", toggle);
        toggle();
    })();

</script>
</body>
</html>
