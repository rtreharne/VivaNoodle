{% load static %}
{% now "U" as cachebust %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MachinaViva | Teacher Dashboard</title>
    <link rel="stylesheet" href="{% static 'tool/home.css' %}?v={{ cachebust }}">
    <script defer src="{% static 'tool/teacher_dashboard.js' %}?v={{ cachebust }}"></script>
</head>
<body>
<div class="page">

    <header class="nav nav-spread">
        <div class="brand">
            <span class="brand-mark">MV</span>
            <span>MachinaViva</span>
        </div>
        {% if from_standalone %}
            <div class="nav-title">{{ assignment.title|default:"Viva assignment" }}</div>
        {% endif %}
        <div class="nav-actions view-toggle">
            {% if from_standalone %}
                <a class="view-btn" href="{% url 'standalone_app_home' %}">My assignments</a>
                <button class="view-btn active" data-view-switch="dashboard">Roster</button>
                <button class="view-btn" data-view-switch="settings">Viva settings</button>
                <button class="view-btn ghost" type="button" data-theme-toggle aria-label="Toggle theme">☀</button>
                <span class="user-chip">
                    {{ request.user.email|default:request.user.username }}
                    <span class="chip-divider">·</span>
                    <a class="link" href="{% url 'standalone_logout' %}">Logout</a>
                </span>
            {% else %}
                <button class="view-btn active" data-view-switch="dashboard">Dashboard</button>
                <button class="view-btn" data-view-switch="settings">Viva settings</button>
                <button class="view-btn ghost" type="button" data-theme-toggle aria-label="Toggle theme">☀</button>
            {% endif %}
        </div>
    </header>

    <section id="dashboard" class="section dash-compact">
        <div class="dash-view active" data-view-pane="dashboard">
            <div class="carousel">
                <div class="carousel-pane active" data-dash-pane="table">
                    <div class="table-controls table-controls-split">
                        <div class="table-controls-left">
                            {% if from_standalone %}
                                <a class="pill neutral" href="#" data-invite-modal-open>Invite students via email</a>
                            {% endif %}
                        </div>
                        <div class="table-controls-right">
                            <input type="search" class="filter-input" placeholder="Filter students by name…" aria-label="Filter students" data-student-filter>
                        </div>
                    </div>
                    <div class="table-card">
                        <div class="table-head">
                            <div>Student</div>
                            <div>Viva</div>
                            <div>Integrity flags</div>
                        </div>

                        {% if students %}
                            {% for student in students %}
                                <div class="table-row" data-student-row data-student-id="{{ student.user_id }}">
                                    <div class="viva-cell">
                                        {% if student.is_invite %}
                                            <span class="monospace">{{ student.name }}</span>
                                            {% if student.invite_status != "Accepted" %}
                                                <span class="pill {% if student.invite_status == 'Expired' %}no{% else %}neutral{% endif %}">{{ student.invite_status|default:"Invited" }}</span>
                                            {% endif %}
                                        {% else %}
                                            {{ student.name }}
                                        {% endif %}
                                    </div>
                                    <div class="viva-cell">
                                        {% if student.status == "completed" %}
                                            <span class="viva-status yes" aria-label="Completed"></span>
                                            <a href="#" class="link view-transcript" data-view-transcript="{{ student.user_id }}">View</a>
                                        {% elif student.status == "in_progress" %}
                                            <span class="viva-status warn" aria-label="In progress"></span>
                                            <a href="#" class="link view-transcript" data-view-transcript="{{ student.user_id }}">Open</a>
                                            <span class="meta">⏱ <span data-remaining="{{ student.remaining_seconds|default:0 }}"></span></span>
                                        {% elif student.status == "submitted" %}
                                            <span class="viva-status no" aria-label="Submitted"></span>
                                            <span class="link disabled">Submitted</span>
                                        {% else %}
                                            {% if student.is_invite and student.invite_id and student.invite_status != "Accepted" %}
                                                <a class="pill neutral" href="{% url 'standalone_invite_resend' student.invite_id %}">Re-send</a>
                                            {% else %}
                                                <span class="viva-status no" aria-label="Pending"></span>
                                                <span class="link disabled">Pending</span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <div class="flag {% if student.flags %}warn{% else %}none{% endif %}">
                                        {% if student.flags %}
                                            {{ student.flags|length }} flag{% if student.flags|length != 1 %}s{% endif %}
                                        {% else %}
                                            None
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="table-row">
                                <div>No roster available</div>
                                <div class="viva-cell"><span class="viva-status no"></span><span class="link disabled">—</span></div>
                                <div class="flag none">—</div>
                            </div>
                        {% endif %}
                    </div>
                    <p class="table-note" data-table-note>Live roster and transcript view for this assignment. Click “View” to open a transcript.</p>
                </div>

                <div class="carousel-pane" data-dash-pane="transcript">
                    <div class="transcript-layout">
                        <div class="transcript-card">
                            <div class="transcript-head">
                                <div>
                                    <div class="name-row">
                                        <span>Student:</span>
                                        <select class="transcript-select" data-transcript-select>
                                            <option value="" selected disabled>Select a student</option>
                                        </select>
                                    </div>
                                    <div class="name-row">
                                        <span>Attempt:</span>
                                        <select class="transcript-select" data-attempt-select>
                                            <option value="" selected disabled>Select attempt</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="transcript-head-actions">
                                    <button class="icon-btn" data-transcript-back title="Back to roster">← Back to roster</button>
                                </div>
                            </div>
                            <div class="transcript-meta">
                                <span class="transcript-assignment">Assignment: {{ assignment.title }}</span>
                                <span class="transcript-duration" data-transcript-duration>Duration: —</span>
                            </div>
                            <div class="transcript-chat" data-transcript-chat>
                                <div class="bubble system">Select a student with a completed viva to view the transcript.</div>
                            </div>
                            <div class="transcript-files" data-transcript-files></div>
                        </div>

                        <aside class="transcript-side">
                            <div class="side-card">
                                <p class="tiny">Integrity events</p>
                                <ul class="event-list transcript-events" data-transcript-events>
                                    <li class="muted">No transcript selected.</li>
                                </ul>
                            </div>
                        </aside>
                    </div>
                </div>

            </div>
        </div>

        <div class="dash-view" data-view-pane="settings">
            <form id="settings-form" class="settings-grid max-two" method="POST" action="{% url 'assignment_edit_save' %}" data-settings-form novalidate>
                {% csrf_token %}
                <div class="settings-form-card">
                    <div class="settings-card-head">
                        <h3 class="settings-title">Overview</h3>
                    </div>
                    <div class="settings-row split">
                        <div>
                            <label>Viva title</label>
                            <div class="meta">{{ assignment.title }}</div>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label for="description">Description</label>
                        <textarea id="description" name="description" rows="2" placeholder="Short summary for staff and students.">{{ assignment.description }}</textarea>
                    </div>
                    <div class="settings-row split">
                        <div>
                            <label for="viva_duration_minutes">Duration</label>
                            <input type="number" id="viva_duration_minutes" name="viva_duration_minutes" min="1" step="1" value="{{ duration_minutes|default:10 }}">
                        </div>
                        <div>
                            <label for="max_attempts">Attempts</label>
                            <input type="number" id="max_attempts" name="max_attempts" min="1" max="5" step="1" value="{{ assignment.max_attempts|default:1 }}" {% if not assignment.max_attempts or assignment.max_attempts <= 0 %}disabled{% endif %}>
                            <div class="unlimited-toggle">
                                <span class="meta">Unlimited</span>
                                <label class="switch">
                                    <input type="checkbox" id="unlimited_attempts" name="unlimited_attempts" {% if not assignment.max_attempts or assignment.max_attempts <= 0 %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label for="viva_tone">Tone</label>
                            <select id="viva_tone" name="viva_tone">
                                {% for tone in tones %}
                                    <option value="{{ tone }}" {% if assignment.viva_tone == tone %}selected{% endif %}>{{ tone }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="settings-row split">
                        <div>
                            <label for="feedback_visibility">Feedback visibility</label>
                            <select id="feedback_visibility" name="feedback_visibility">
                                <option value="immediate" {% if assignment.feedback_visibility == "immediate" %}selected{% endif %}>Show immediately</option>
                                <option value="after_review" {% if assignment.feedback_visibility == "after_review" %}selected{% endif %}>After teacher review</option>
                                <option value="hidden" {% if assignment.feedback_visibility == "hidden" %}selected{% endif %}>Hide</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>Student report</label>
                        <div class="tracking-table">
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Download feedback/transcript</div>
                                    <div class="meta">Allow students to export their session.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="allow_student_report" {% if assignment.allow_student_report %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Allow early submission</div>
                                    <div class="meta">Students can finish before the timer ends.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="allow_early_submission" {% if assignment.allow_early_submission %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Enable model answers</div>
                                    <div class="meta">Show exemplar answers after completion.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="enable_model_answers" {% if assignment.enable_model_answers %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Allow students to toggle instructor files</div>
                                    <div class="meta">Students must include at least one file.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="allow_student_resource_toggle" {% if assignment.allow_student_resource_toggle %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>Tracking</label>
                        <div class="tracking-table">
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Event tracking</div>
                                    <div class="meta">Paste, blur/focus, window changes.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="event_tracking" {% if assignment.event_tracking %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Keystroke tracking</div>
                                    <div class="meta">Pacing signals.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="keystroke_tracking" {% if assignment.keystroke_tracking %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="tracking-item">
                                <div>
                                    <div class="tracking-label">Arrhythmic typing</div>
                                    <div class="meta">Flag irregular bursts.</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="arrhythmic_typing" {% if assignment.arrhythmic_typing %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-form-card">
                    <div class="settings-card-head">
                        <h3 class="settings-title">Tone & guidance</h3>
                    </div>
                    <div class="settings-row">
                        <label for="viva_instructions">Core viva instructions</label>
                        <textarea id="viva_instructions" name="viva_instructions" rows="4" placeholder="How should the AI conduct the viva? Tone, strictness, what to probe, what to avoid.">{{ assignment.viva_instructions }}</textarea>
                    </div>

                    <div class="settings-row">
                        <label for="additional_prompts">Additional prompts</label>
                        <textarea id="additional_prompts" name="additional_prompts" rows="3" placeholder="Any bespoke prompts or discipline-specific instructions.">{{ assignment.additional_prompts }}</textarea>
                    </div>

                    <div class="settings-row">
                        <label for="instructor_notes">Instructor notes (private)</label>
                        <textarea id="instructor_notes" name="instructor_notes" rows="3" placeholder="Private notes about this viva.">{{ assignment.instructor_notes }}</textarea>
                    </div>
                </div>

                <div class="settings-form-card" data-resource-upload>
                    <div class="settings-card-head">
                        <h3 class="settings-title">Viva files</h3>
                    </div>
                    <div class="settings-row">
                        <label>Files</label>
                        <div class="submission-table-wrap" data-resource-list>
                            <div class="submission-table-header">
                                <span>File</span>
                                <span>Include</span>
                                <span>Actions</span>
                            </div>
                            <div class="submission-table-body">
                                {% for resource in assignment_resources %}
                                    <div class="submission-row {% cycle 'row-alt' '' %}"
                                         data-resource-id="{{ resource.id }}"
                                         data-included="{{ resource.included|yesno:'1,0' }}"
                                         data-file-name="{{ resource.file_name|cut:'assignment_resources/'|default:'uploaded file' }}"
                                         data-comment="{{ resource.comment|default_if_none:''|escapejs }}"
                                         data-file-size="{{ resource.file_size|default:0 }}">
                                        <div class="submission-cell file-name">
                                            {{ resource.file_name|cut:"assignment_resources/"|default:"uploaded file"|truncatechars:40 }}
                                            <div class="meta">
                                                <a class="link file-preview"
                                                   href="#"
                                                   data-preview-text="{{ resource.comment|default_if_none:''|escapejs }}">
                                                    Preview text
                                                </a>
                                            </div>
                                        </div>
                                        <div class="submission-cell">
                                            <label class="slider-toggle" aria-label="Include in viva">
                                                <input type="checkbox" data-resource-include {% if resource.included %}checked{% endif %}>
                                                <span class="slider-track">
                                                    <span class="slider-thumb"></span>
                                                </span>
                                            </label>
                                        </div>
                                        <div class="submission-cell submission-actions">
                                            <button class="icon-btn danger" type="button" data-delete-resource="{{ resource.id }}">Delete</button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="meta {% if assignment_resources %}is-hidden{% endif %}" data-resource-empty>
                            No viva files yet. Upload files below.
                        </div>
                    </div>
                    <div class="settings-row">
                        <label>Upload files</label>
                        <div class="submission-form upload-inline"
                             data-resource-upload-form
                             data-upload-url="{% url 'upload_assignment_resource' %}"
                             data-existing-count="{{ assignment_resources|length|default:0 }}"
                             data-existing-size="{{ resources_total_size|default:0 }}">
                            <input type="file" name="file" accept=".pdf,.docx,.txt" multiple data-resource-upload-input>
                            <button type="button" class="control-btn" data-resource-upload-btn>Upload</button>
                        </div>
                        <div class="meta upload-hint is-hidden" data-resource-upload-hint></div>
                    </div>
                </div>

                <div class="settings-actions">
                    <span class="meta" data-save-status></span>
                </div>
            </form>

            {% if from_standalone %}
            <div class="settings-grid max-two">
                <div class="settings-form-card">
                    <div class="settings-card-head">
                        <h3 class="settings-title">Invite students</h3>
                    </div>
                    <form method="post" action="{% url 'standalone_invite_create' assignment.slug %}" class="settings-grid single-column">
                        {% csrf_token %}
                        <div class="settings-row">
                            <label for="invite-email">Student email</label>
                            <input id="invite-email" name="email" type="email" required>
                        </div>
                        <div class="settings-actions">
                            <button type="submit" class="view-btn">Send invite</button>
                        </div>
                    </form>
                </div>
                <div class="settings-form-card">
                    <div class="settings-card-head">
                        <h3 class="settings-title">Recent invites</h3>
                    </div>
                    {% if invites %}
                        <div class="table-card">
                            <div class="table-head cols-2">
                                <div>Email</div>
                                <div>Status</div>
                            </div>
                            {% for invite in invites %}
                                <div class="table-row cols-2">
                                    <div class="monospace">{{ invite.email }}</div>
                                    <div class="inline-actions">
                                        {% if invite.accepted_at %}
                                            <span class="pill yes">Accepted</span>
                                        {% else %}
                                            {% if invite.is_expired %}
                                                <span class="pill no">Expired</span>
                                            {% else %}
                                                <span class="pill neutral">Pending</span>
                                            {% endif %}
                                            <a class="pill neutral" href="{% url 'standalone_invite_resend' invite.id %}">Resend</a>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="muted">No invites yet.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        <button class="back-to-top" type="button" data-back-to-top aria-label="Back to top">↑ Top</button>
    </section>

    <footer class="footer">
        <p>© {{ now|date:"Y" }} MachinaViva · Authentic viva assessments for the AI era.</p>
    </footer>
</div>

{{ dashboard_data|json_script:"dashboard-data" }}
<div class="save-toast" data-save-toast>Settings updated</div>
<div class="preview-modal" data-preview-modal>
    <div class="preview-dialog">
        <div class="preview-head">
            <span>Submission preview</span>
            <button class="icon-btn" type="button" data-preview-close aria-label="Close preview">×</button>
        </div>
        <div class="preview-body">
            <pre data-preview-content>(No preview available)</pre>
        </div>
    </div>
</div>
{% if from_standalone %}
<div class="invite-modal" data-invite-modal>
    <div class="invite-dialog">
        <div class="invite-head">
            <h3>Invite students via email</h3>
            <button class="icon-btn" type="button" data-invite-close aria-label="Close invite form">×</button>
        </div>
        <form method="post" action="{% url 'standalone_invite_create' assignment.slug %}" class="settings-grid single-column">
            {% csrf_token %}
            <div class="settings-row">
                <label for="invite-email-modal">Student email</label>
                <input id="invite-email-modal" name="email" type="email" required>
            </div>
            <div class="settings-actions">
                <button type="submit" class="view-btn">Send invite</button>
                <button type="button" class="view-btn ghost" data-invite-close>Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endif %}
<script>
    (() => {
        const unlimited = document.getElementById("unlimited_attempts");
        const attempts = document.getElementById("max_attempts");
        if (!unlimited || !attempts) return;
        const toggle = () => {
            attempts.disabled = unlimited.checked;
            if (unlimited.checked) {
                attempts.value = 0;
            } else if (!attempts.value || Number(attempts.value) < 1) {
                attempts.value = 1;
            }
        };
        unlimited.addEventListener("change", toggle);
        toggle();
    })();

    (() => {
        const openBtn = document.querySelector("[data-invite-modal-open]");
        const modal = document.querySelector("[data-invite-modal]");
        const closes = document.querySelectorAll("[data-invite-close]");
        if (!openBtn || !modal) return;
        const open = (e) => {
            e?.preventDefault();
            modal.classList.add("open");
        };
        const close = (e) => {
            e?.preventDefault();
            modal.classList.remove("open");
        };
        openBtn.addEventListener("click", open);
        closes.forEach(btn => btn.addEventListener("click", close));
        modal.addEventListener("click", (e) => {
            if (e.target === modal) close();
        });
    })();
</script>
</body>
</html>
