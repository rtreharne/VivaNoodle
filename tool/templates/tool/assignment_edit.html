{% load static %}
{% load tz %}
{% now "U" as cachebust %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MachinaViva | Edit Viva Settings</title>
    <link rel="stylesheet" href="{% static 'tool/home.css' %}?v={{ cachebust }}">
    <script defer src="{% static 'tool/nav.js' %}?v={{ cachebust }}"></script>
</head>
<body>
<div class="page">

    <header class="nav nav-with-menu">
        <div class="brand">
            <span class="brand-mark">MV</span>
            <span>MachinaViva</span>
        </div>
        <div class="nav-title">{{ assignment.title|default:"Viva assignment" }}</div>
        <button class="nav-toggle" data-nav-toggle aria-label="Toggle navigation">Menu</button>
        <div class="nav-actions view-toggle" data-nav-links>
            <a class="view-btn" href="{% url 'assignment_view' %}">Dashboard</a>
            <a class="view-btn active" href="#">Viva settings</a>
            <button class="view-btn ghost" type="button" data-theme-toggle aria-label="Toggle theme">Light</button>
        </div>
    </header>

    <section class="section dash-compact">
        <div class="section-head compact">
            <div>
                <p class="eyebrow">Edit viva configuration</p>
                <h2>{{ assignment.title }}</h2>
            </div>
        </div>

        <form method="POST" action="{% url 'assignment_edit_save' %}" class="settings-grid max-two" novalidate>
            {% csrf_token %}

            <div class="settings-form-card">
                <div class="settings-card-head">
                    <h3 class="settings-title">Timing & access</h3>
                </div>
                <div class="settings-row">
                    <label>Assignment Title</label>
                    <input type="text" value="{{ assignment.title }}" disabled>
                    <p class="meta">Title comes from your LMS.</p>
                </div>
                <div class="settings-row">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3" placeholder="Short summary for staff and students.">{{ assignment.description }}</textarea>
                </div>
                <div class="settings-row">
                    <label for="deadline_at">Deadline</label>
                    <input
                        type="datetime-local"
                        id="deadline_at"
                        name="deadline_at"
                        value="{% if assignment.deadline_at %}{{ assignment.deadline_at|localtime|date:"Y-m-d\\TH:i" }}{% endif %}"
                    >
                    <p class="meta">Uses the instructor timezone.</p>
                </div>
                <div class="settings-row split">
                    <div>
                        <label for="viva_duration_minutes">Duration</label>
                        <input type="number" id="viva_duration_minutes" name="viva_duration_minutes" min="1" step="1" value="{{ duration_minutes }}"> minutes
                    </div>
                    <div>
                        <label for="max_attempts">Multiple attempts</label>
                        <input type="number" id="max_attempts" name="max_attempts" min="1" max="5" step="1" value="{{ assignment.max_attempts|default:1 }}" {% if not assignment.max_attempts or assignment.max_attempts <= 0 %}disabled{% endif %}>
                        <div class="unlimited-toggle">
                            <span class="meta">Unlimited</span>
                            <label class="switch">
                                <input type="checkbox" id="unlimited_attempts" name="unlimited_attempts" {% if not assignment.max_attempts or assignment.max_attempts <= 0 %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="settings-row">
                    <label>Feedback visibility</label>
                    <div class="tracking-table">
                        <div class="tracking-item">
                            <div>
                                <div class="tracking-label">Show AI feedback</div>
                                <div class="meta">AI feedback is visible to students.</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" name="ai_feedback_visible" {% if assignment.ai_feedback_visible %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="tracking-item">
                            <div>
                                <div class="tracking-label">Show teacher feedback</div>
                                <div class="meta">Teacher feedback is visible to students.</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" name="teacher_feedback_visible" {% if assignment.teacher_feedback_visible %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="settings-row">
                    <label>Allow student to download report</label>
                    <label class="switch">
                        <input type="checkbox" name="allow_student_report" {% if assignment.allow_student_report %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-row">
                    <label>Allow early submission</label>
                    <label class="switch">
                        <input type="checkbox" name="allow_early_submission" {% if assignment.allow_early_submission %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                    <div class="meta">Students can submit before time expires.</div>
                </div>
                <div class="settings-row">
                    <label>Enable model answers</label>
                    <label class="switch">
                        <input type="checkbox" name="enable_model_answers" {% if assignment.enable_model_answers %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                    <div class="meta">Show exemplar answers after completion.</div>
                </div>
                <div class="settings-row">
                    <label>Allow students to toggle instructor files</label>
                    <label class="switch">
                        <input type="checkbox" name="allow_student_resource_toggle" {% if assignment.allow_student_resource_toggle %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                    <div class="meta">Students must include at least one file.</div>
                </div>
            </div>

            <div class="settings-form-card">
                <div class="settings-card-head">
                    <h3 class="settings-title">Tone & guidance</h3>
                </div>
                <div class="settings-row split">
                    <div>
                        <label for="viva_tone">Tone</label>
                        <select id="viva_tone" name="viva_tone">
                            {% for tone in tones %}
                                <option value="{{ tone }}" {% if assignment.viva_tone == tone %}selected{% endif %}>{{ tone }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label>Tracking</label>
                        <div class="meta">{% if assignment.event_tracking %}Events{% else %}—{% endif %}{% if assignment.keystroke_tracking %}, Keystrokes{% endif %}{% if assignment.arrhythmic_typing %}, Arrhythmic{% endif %}</div>
                    </div>
                </div>
                <div class="settings-row">
                    <label for="viva_instructions">Core viva instructions</label>
                    <textarea id="viva_instructions" name="viva_instructions" rows="4" placeholder="How should the AI conduct the viva? Tone, strictness, what to probe, what to avoid.">{{ assignment.viva_instructions }}</textarea>
                </div>

                <div class="settings-row">
                    <label for="additional_prompts">Additional prompts</label>
                    <textarea id="additional_prompts" name="additional_prompts" rows="3" placeholder="Any bespoke prompts or discipline-specific instructions.">{{ assignment.additional_prompts }}</textarea>
                </div>

                <div class="settings-row">
                    <label for="instructor_notes">Instructor notes (private)</label>
                    <textarea id="instructor_notes" name="instructor_notes" rows="3" placeholder="Private notes about this viva.">{{ assignment.instructor_notes }}</textarea>
                </div>

                <div class="settings-row split">
                    <div>
                        <label>Event tracking</label>
                        <label class="switch">
                            <input type="checkbox" name="event_tracking" {% if assignment.event_tracking %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                        <div class="meta">Track paste, blur/focus, and window changes.</div>
                    </div>
                    <div>
                        <label>Keystroke tracking</label>
                        <label class="switch">
                            <input type="checkbox" name="keystroke_tracking" {% if assignment.keystroke_tracking %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                        <div class="meta">Log keypress activity for pacing signals.</div>
                    </div>
                    <div>
                        <label>Arrhythmic typing detection</label>
                        <label class="switch">
                            <input type="checkbox" name="arrhythmic_typing" {% if assignment.arrhythmic_typing %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                        <div class="meta">Flag irregular typing bursts.</div>
                    </div>
                </div>
            </div>

            <div class="settings-actions">
                <button class="control-btn primary" type="submit">Save settings</button>
                <a class="ghost-btn" href="{% url 'assignment_view' %}">Cancel</a>
            </div>
        </form>
    </section>

    <footer class="footer">
        <p>© 2025 MachinaViva</p>
    </footer>
</div>
<script>
    (() => {
        const unlimited = document.getElementById("unlimited_attempts");
        const attempts = document.getElementById("max_attempts");
        if (!unlimited || !attempts) return;
        const toggle = () => {
            attempts.disabled = unlimited.checked;
            if (unlimited.checked) {
                attempts.value = 0;
            } else if (!attempts.value || Number(attempts.value) < 1) {
                attempts.value = 1;
            }
        };
        unlimited.addEventListener("change", toggle);
        toggle();
    })();
</script>
</body>
</html>
