{% load static %}
{% now "U" as cachebust %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MachinaViva | Student Dashboard</title>
    <style>
        /* Minimal critical styles to prevent flash */
        html.preload, body.preload {
            background: #0d1224;
            color: #e2e8f0;
        }
        html.preload .page {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
    </style>
    <link id="main-css" rel="preload" as="style" href="{% static 'tool/home.css' %}?v={{ cachebust }}" onload="this.rel='stylesheet'; document.documentElement.classList.remove('preload'); document.body.classList.remove('preload');">
    <noscript>
        <link rel="stylesheet" href="{% static 'tool/home.css' %}?v={{ cachebust }}">
    </noscript>
    <script>
        // Ensure preload class is removed even if load fires late
        document.documentElement.classList.add('preload');
        document.body.classList.add('preload');
        const finishPreload = () => {
            document.documentElement.classList.remove('preload');
            document.body.classList.remove('preload');
        };
        const cssLink = document.getElementById('main-css');
        if (cssLink && cssLink.sheet) finishPreload();
        else cssLink?.addEventListener('load', finishPreload);
        window.addEventListener('load', finishPreload);
    </script>
    <script defer src="{% static 'tool/student_dashboard.js' %}?v={{ cachebust }}"></script>
</head>
<body>
<div class="page"
     data-viva-status="{{ viva_status|default:'pending' }}"
     {% if session %}data-viva-session-id="{{ session.id }}"{% endif %}
     data-viva-duration="{{ assignment.viva_duration_seconds|default:600 }}"
     data-attempts-left="{{ attempts_left|default:0 }}"
     data-attempts-used="{{ attempts_used|default:0 }}"
     data-feedback-visibility="{{ assignment.feedback_visibility|default:'immediate' }}"
     data-unlimited-attempts="{% if assignment.max_attempts and assignment.max_attempts > 0 %}false{% else %}true{% endif %}"
     data-config-files-included="{% if config_files_included %}true{% else %}false{% endif %}"
     data-event-tracking="{% if assignment.event_tracking %}true{% else %}false{% endif %}"
     data-keystroke-tracking="{% if assignment.keystroke_tracking %}true{% else %}false{% endif %}"
     data-arrhythmic-typing="{% if assignment.arrhythmic_typing %}true{% else %}false{% endif %}"
     data-model-answers-enabled="{% if assignment.enable_model_answers %}true{% else %}false{% endif %}"
     data-instructor-toggle-enabled="{% if assignment.allow_student_resource_toggle %}true{% else %}false{% endif %}"
     data-allow-early-submit="{% if assignment.allow_early_submission %}true{% else %}false{% endif %}">

    <header class="nav nav-spread">
        <div class="brand">
            <span class="brand-mark">MV</span>
            <span>MachinaViva</span>
        </div>
        <div class="nav-title">{{ assignment.title|default:"Viva assignment" }}</div>
        <div class="nav-actions">
            {% if request.user.is_authenticated %}
            <a class="view-btn" href="{% url 'standalone_student_assignments' %}">My assignments</a>
            {% endif %}
            <span class="badge viva-nav-timer is-hidden"
                  data-viva-timer
                  data-viva-minutes="{{ duration_minutes|default:10 }}"
                  data-viva-seconds="{{ remaining_seconds|default_if_none:0 }}">00:00</span>
            <button class="view-btn ghost" type="button" data-theme-toggle aria-label="Toggle theme">☾</button>
            {% if user_email and logout_url %}
            <span class="user-chip">
                {{ user_email }}
                <span class="chip-divider">•</span>
                <a class="link" href="{% url logout_url %}">Logout</a>
            </span>
            {% endif %}
        </div>
    </header>

    <section class="section dash-compact">

        <div class="settings-grid single-column">
            <div class="settings-form-card" data-viva-summary-card>
                <div class="settings-card-head">
                    <h3 class="settings-title">Viva Dashboard</h3>
                    <div class="meta attempts-left-meta" data-attempts-meta style="margin-top:4px;">
                        {% if attempts_left < 0 %}
                            Unlimited viva attempts
                        {% elif attempts_left > 0 %}
                            <span data-attempts-left>{{ attempts_left }}</span> viva attempt{% if attempts_left != 1 %}s{% endif %} left
                        {% elif attempts_left == 0 and assignment.max_attempts|default:0 <= 0 %}
                            Unlimited viva attempts
                        {% else %}
                            No viva attempts remaining
                        {% endif %}
                    </div>
                    {% if latest_submission %}
                        {% if viva_status != "completed" or attempts_left|default:0 > 0 or assignment.max_attempts|default:0 <= 0 %}
                            <button class="control-btn ghost"
                                    type="button"
                                    data-summary-cta
                                    data-start-url="{% url 'viva_start' latest_submission.id %}"
                                    data-cta-state="{% if viva_status == 'in_progress' %}active{% else %}ready{% endif %}">
                                {% if viva_status == "in_progress" %}Return to viva{% else %}Start Viva{% endif %}
                            </button>
                        {% endif %}
                    {% endif %}
                </div>

                <div class="settings-row split">
                    <div>
                    {% if latest_submission %}
                        {% if viva_status == "in_progress" %}
                            {% if attempts_left > 0 %}
                                <div class="meta">In progress (attempt {{ attempts_used }} of {{ assignment.max_attempts|default:1 }})</div>
                            {% endif %}
                            {% if remaining_seconds %}
                                <div class="meta">Time remaining: <span data-remaining="{{ remaining_seconds|default:0 }}"></span></div>
                            {% endif %}
                        {% elif viva_status == "completed" %}
                            {% if session %}
                                <div class="viva-action">
                                    <a class="control-btn" href="{% url 'viva_summary' session.id %}">View summary</a>
                                </div>
                            {% endif %}
                        {% endif %}
                    {% else %}
                        <div class="meta">Submit your work to start the viva.</div>
                    {% endif %}
                    {% if viva_sessions %}
                        <div class="viva-action" style="margin-top:8px;">
                            <label class="meta" style="display:block; margin-bottom:6px;">Previous viva attempts</label>
                            <div class="attempt-table">
                                {% for vs in viva_sessions %}
                                    <div class="attempt-row" data-attempt-row data-started-at="{{ vs.started_at|date:'c' }}">
                                        <span class="meta">Attempt {{ forloop.revcounter }} · {{ vs.started_at|date:"Y-m-d H:i" }}</span>
                                        <span class="attempt-actions">
                                            <a class="link view-attempt" href="#" data-view-session="{{ vs.id }}">View</a>
                                        </span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
                </div>

                <div class="settings-row">
                    <label>Viva files (instructor)</label>
                    <div class="submission-table-wrap" data-instructor-resources>
                        <div class="submission-table-header">
                            <span>File</span>
                            <span>Include</span>
                            <span>Actions</span>
                        </div>
                        <div class="submission-table-body">
                            {% for resource in assignment_resources %}
                                <div class="submission-row {% cycle 'row-alt' '' %}"
                                     data-instructor-resource
                                     data-resource-id="{{ resource.id }}"
                                     data-included="{{ resource.included|yesno:'1,0' }}"
                                     data-file-name="{{ resource.file_name|cut:'assignment_resources/'|default:'uploaded file' }}"
                                     data-comment="{{ resource.comment|default_if_none:''|escapejs }}"
                                     data-file-size="{{ resource.file_size|default:0 }}">
                                    <div class="submission-cell file-name">
                                        {{ resource.file_name|cut:"assignment_resources/"|default:"uploaded file"|truncatechars:40 }}
                                        <div class="meta">
                                            <a class="link file-preview"
                                               href="#"
                                               data-preview-text="{{ resource.comment|default_if_none:''|escapejs }}">
                                                Preview text
                                            </a>
                                        </div>
                                    </div>
                                    <div class="submission-cell">
                                        <label class="slider-toggle" aria-label="Included in viva">
                                            <input type="checkbox" data-instructor-include {% if resource.included %}checked{% endif %} {% if not assignment.allow_student_resource_toggle %}disabled{% endif %}>
                                            <span class="slider-track">
                                                <span class="slider-thumb"></span>
                                            </span>
                                        </label>
                                    </div>
                                    <div class="submission-cell submission-actions">
                                        {% if assignment.allow_student_resource_toggle %}
                                            <span class="meta muted">Toggle to include</span>
                                        {% else %}
                                            <span class="meta muted">Managed by instructor</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="meta {% if assignment_resources %}is-hidden{% endif %}">
                        No instructor files yet.
                    </div>
                </div>

                <div class="settings-row">
                    <label>Your uploads</label>
                    {% if submission_payloads %}
                        <div class="submission-table-wrap" data-submission-list {% if session %}data-active-session="{{ session.id }}"{% endif %}>
                            <div class="submission-table-header">
                                <span>File</span>
                                <span>Include</span>
                                <span>Actions</span>
                            </div>
                            <div class="submission-table-body">
                                {% for sub in submission_payloads %}
                                    <div class="submission-row {% cycle 'row-alt' '' %}"
                                         data-submission-id="{{ sub.id }}"
                                         data-included="{{ sub.included|yesno:'1,0' }}"
                                         data-file-name="{{ sub.file_name|cut:'submissions/'|cut:'submission/'|default:'uploaded file' }}"
                                         data-comment="{{ sub.comment|default_if_none:''|escapejs }}"
                                         data-file-size="{{ sub.file_size|default:0 }}"
                                         data-start-url="{% url 'viva_start' sub.id %}">
                                        <div class="submission-cell file-name">
                                            {{ sub.file_name|cut:"submissions/"|cut:"submission/"|default:"uploaded file"|truncatechars:40 }}
                                            <div class="meta">
                                                <a class="link file-preview"
                                                   href="#"
                                                   data-preview-text="{{ sub.comment|default_if_none:''|escapejs }}">
                                                    Preview text
                                                </a>
                                            </div>
                                        </div>
                                        <div class="submission-cell">
                                            <label class="slider-toggle" aria-label="Include in viva">
                                                <input type="checkbox" data-toggle-include {% if sub.included %}checked{% endif %}>
                                                <span class="slider-track">
                                                    <span class="slider-thumb"></span>
                                                </span>
                                            </label>
                                        </div>
                                        <div class="submission-cell submission-actions">
                                            {% if sub.can_delete %}
                                                <button class="icon-btn danger" type="button" data-delete-submission="{{ sub.id }}">Delete</button>
                                            {% else %}
                                                <span class="meta muted">Linked to a viva</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="meta">No uploads yet. Add files below.</div>
                    {% endif %}
                </div>

                {% if attempts_left|default:0 > 0 or assignment.max_attempts|default:0 <= 0 %}
                    <div class="settings-row">
                        <label>Upload files</label>
                        <form action="{% url 'submit_file' %}" method="POST" enctype="multipart/form-data" class="submission-form upload-inline" data-upload-form data-existing-count="{{ submission_payloads|length|default:0 }}" data-existing-size="{{ submissions_total_size|default:0 }}">
                            {% csrf_token %}
                            <input type="file" id="file" name="file" accept=".pdf,.docx,.txt" multiple required>
                            <button type="submit" class="control-btn">Upload</button>
                        </form>
                        <div class="meta upload-hint is-hidden" data-upload-hint></div>
                    </div>
                {% endif %}

                {% if feedback %}
                    <div class="settings-row">
                        <label>Feedback</label>
                        <div class="meta"><strong>Strengths:</strong> {{ feedback.strengths }}</div>
                        <div class="meta"><strong>Improvements:</strong> {{ feedback.improvements }}</div>
                        <div class="meta"><strong>Impression:</strong> {{ feedback.impression }}</div>
                    </div>
                {% endif %}
            </div>

            <div class="settings-form-card is-hidden" data-viva-chat-card>
                <div class="settings-card-head">
                    <h3 class="settings-title">Viva chat</h3>
                    <div class="viva-head-actions">
                        <button class="control-btn ghost is-hidden" type="button" data-early-submit>Submit early</button>
                        <button class="control-btn ghost is-hidden" type="button" data-toggle-model>Show model answers</button>
                        <button class="control-btn ghost" type="button" data-back-dashboard>Back</button>
                    </div>
                </div>
                <div class="viva-chat-card">
                    <div class="viva-chat-wrap">
                        <div class="panel-chat viva-chat-window"
                             data-viva-chat-window
                             data-initial-ai="... Before we begin: answer in your own words, keep replies concise, stay focused on your submission. The viva will start as soon as you respond to this message."></div>
                    </div>
                    <div class="input-row viva-input">
                        <div class="input-shell">
                            <input type="text" placeholder="Type your response..." disabled data-viva-input>
                        </div>
                        <button class="send-btn viva-send-btn" type="button" disabled data-viva-send>Send</button>
                    </div>
                    <div class="viva-files is-hidden" data-viva-files></div>
                </div>
            </div>

            <div class="settings-form-card">
                <div class="settings-card-head">
                    <h3 class="settings-title">Assignment info</h3>
                </div>
                {% if assignment.description %}
                <div class="settings-row">
                    <label>Description</label>
                    <div class="meta description-box">{{ assignment.description }}</div>
                </div>
                {% endif %}
                <div class="settings-row split">
                    <div>
                        <label>Duration</label>
                        <div class="meta">{{ duration_minutes|default:10 }} minutes</div>
                    </div>
                    <div>
                        <label>Attempts</label>
                        <div class="meta">
                            {% if assignment.max_attempts and assignment.max_attempts > 0 %}
                                {{ assignment.max_attempts }} allowed
                            {% else %}
                                Unlimited attempts
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="settings-row">
                    <label>Feedback</label>
                    <div class="meta">
                        {% if assignment.feedback_visibility == "hidden" %}Feedback hidden{% elif assignment.feedback_visibility == "after_review" %}Feedback after teacher review{% else %}Feedback shown immediately{% endif %}
                    </div>
                </div>
                <div class="settings-row">
                    <label>Downloads</label>
                    <div class="meta">{% if assignment.allow_student_report %}You can download your transcript/feedback{% else %}Downloads disabled{% endif %}</div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <p>© {{ now|date:"Y" }} MachinaViva · Authentic viva assessments for the AI era.</p>
    </footer>
</div>

<div class="preview-modal" data-preview-modal>
    <div class="preview-dialog">
        <div class="preview-head">
            <span>Submission preview</span>
            <button class="icon-btn" type="button" data-preview-close aria-label="Close preview">×</button>
        </div>
        <div class="preview-body">
            <pre data-preview-content>(No preview available)</pre>
        </div>
    </div>
</div>
{{ session_histories|json_script:"session-histories-data" }}
{{ session_files|json_script:"session-files-data" }}
{{ session_meta|json_script:"session-meta-data" }}
{{ config_files|json_script:"config-files-data" }}
</body>
</html>
